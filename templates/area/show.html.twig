{% extends 'layout.html.twig' %}

{% set hasDebt = 0 > balance %}

{% block content %}
    <h1>Участок №{{ area.number }}</h1>

    <dl class="dl-horizontal">
        <dt>Количество соток</dt>
        <dd>{{ area.size / 100 }}</dd>
        {% if is_granted(constant('App\\Roles::COMMUNITY')) %}
            <dt>Владельцы</dt>
            <dd>
                <ul>
                    {% for user in area.users %}
                        <li>{{ user.realname }}</li>
                    {% endfor %}
                </ul>
            </dd>
        {% endif %}
        <dt>Улица</dt>
        <dd>
            {% if area.street %}
                {{ area.street.name }}
            {% endif %}
        </dd>
    </dl>

    <h2>Платежи</h2>

    {% if 0 < pagerfanta.count %}
        <table class="table">
            <thead>
            <tr>
                <th>Наименование</th>
                <th>К оплате</th>
                <th>Оплачено</th>
                <th>Недоплата / Переплата</th>
                <th>Дата создания</th>
                {% if hasDebt %}
                    <th>Оплата</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% for item in pagerfanta.currentPageResults %}
                {# @var purpose \App\Entity\Purpose #}
                {% set purpose = item|first %}
                {% set sum = item.bill + item.paid %}
                {% set paid = sum >= 0 %}
                {% set pay = ((item.bill + item.paid) / 100)|round(0, 'ceil') %}

                <tr>
                    <td>{{ purpose.name }}</td>
                    <td>{{ (item.bill|abs / 100)|number_format }}</td>
                    <td>{{ (item.paid / 100)|number_format }}</td>
                    <td><strong>{{ pay|number_format }}</strong></td>
                    <td>{{ purpose.createdAt|localizeddate }}</td>
                    {% if not paid %}
                        <td>
                            <form method="post" action="https://www.payanyway.ru/assistant.htm">
                                <input type="hidden" name="MNT_ID" value="87482468">
                                <input type="hidden" name="MNT_TEST_MODE" value="0">

                                <input type="hidden" name="MNT_CURRENCY_CODE" value="RUB">
                                <input type="hidden" name="MNT_AMOUNT" value="{{ pay * -1 }}">

                                <input type="hidden" name="MNT_SUCCESS_URL" value="{{ url('area_show_payment_return', {
                                    'status': constant('App\\Controller\\AreaController::PAYMENT_STATUS_SUCCESS'),
                                    'number': area.number
                                }) }}">
                                <input type="hidden" name="MNT_FAIL_URL" value="{{ url('area_show_payment_return', {
                                    'status': constant('App\\Controller\\AreaController::PAYMENT_STATUS_FAILURE'),
                                    'number': area.number
                                }) }}">

                                <input type="hidden" name="MNT_RETURN_URL" value="{{ app.request.uri }}">
                                <input type="hidden" name="MNT_AREA" value="{{ area.id }}">
                                <input type="hidden" name="MNT_PURPOSE" value="{{ purpose.id }}">
                                <input type="hidden" name="MNT_USER" value="{{ app.user.id }}">

                                <button class="btn btn-success" type="submit">Оплатить</button>
                            </form>
                        </td>
                    {% endif %}
                </tr>
            {% endfor %}

            <tr class="{{ hasDebt ? 'danger' }}">
                <td colspan="3">Баланс</td>
                <td colspan="2">{{ (balance / 100)|number_format }}</td>
            </tr>
            </tbody>
        </table>

        {% if pagerfanta.haveToPaginate %}
                <div class="text-center">
                    {{ pagerfanta(pagerfanta, 'twitter_bootstrap3_translated') }}
                </div>
            {% endif %}
    {% else %}
        <div class="jumbotron">
            <h2>Записей нет</h2>
        </div>
    {% endif %}
{% endblock %}
