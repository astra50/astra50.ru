services:
  database:
    image: mariadb
    environment:
      MYSQL_DATABASE: db
      MYSQL_ALLOW_EMPTY_PASSWORD: true

pipeline:
  build:
    image: docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t registry.gitlab.com/astra50/astra50.ru:${DRONE_BUILD_NUMBER} .
      - docker run --rm docker sh -c "while ! nc -z 127.0.0.1 3306; do sleep 1; done"
      - >-
        (docker run --rm --network "container:$HOSTNAME"
        -e SYMFONY_ENV=test
        -e SYMFONY_DEBUG=0
        -e DATABASE_HOST=127.0.0.1
        -e DATABASE_USER="user"
        -e DATABASE_PASSWORD="password"
        registry.gitlab.com/astra50/astra50.ru:${DRONE_BUILD_NUMBER}); local result=$?;
      - >+
        if [ "$result" == 0 ]; then
          docker login -u"$HUB_LOGIN" -p"$HUB_PASSWORD" registry.gitlab.com
          docker push registry.gitlab.com/astra50/astra50.ru:${DRONE_BUILD_NUMBER} > /dev/null
          docker rmi --force `docker images -q --filter "before=registry.gitlab.com/astra50/astra50.ru:${DRONE_BUILD_NUMBER}" registry.gitlab.com/astra50/astra50.ru` || true
        else
          docker rmi --force registry.gitlab.com/astra50/astra50.ru:${DRONE_BUILD_NUMBER}
        fi
      - exit "$result"

  deploy:
    image: plugins/ssh
    host:
      - s2.automagistre.ru
      - s1.grachevko.ru
    user: premier
    port: 22
    script:
      - docker service update --image registry.gitlab.com/astra50/astra50.ru:${DRONE_BUILD_NUMBER} astra50_app
      - docker rmi `docker images -q --filter "before=registry.gitlab.com/astra50/astra50.ru:${DRONE_BUILD_NUMBER}" registry.gitlab.com/astra50/astra50.ru` 2> /dev/null || true
    when:
      branch: master
